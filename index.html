<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>å¶™Â·è´´èº«ï¼ˆæ°”æ³¡åŠ©ç† v1.0ï¼‰</title>
<meta name="theme-color" content="#0f0f12"/>
<link rel="manifest" href="manifest.webmanifest">
<style>
:root{
  --bg:#0f0f12;--ink:#e9edf7;--muted:#9aa4b2;--card:#141824;--edge:#21283a;--acc:#8daaff;--acc2:#00c8a0;--warn:#ff9db4;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
.wrap{max-width:900px;margin:0 auto;padding:18px}
h1{margin:0 0 8px 0;font-size:22px}
.sub{color:var(--muted);font-size:13px}
.card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:14px;position:relative;overflow:hidden}
.grid{display:flex;gap:10px;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--edge);border-radius:999px;color:#cdd6e3;font-size:12px}
.btn{border:none;border-radius:12px;background:#1b2030;color:#fff;padding:10px 12px}
hr{border:none;height:1px;background:#202738;margin:10px 0}

/* bubble */
#fab{position:fixed;right:16px;bottom:18px;width:64px;height:64px;border-radius:50%;background:#1b2030;border:1px solid #2a3245;
display:flex;align-items:center;justify-content:center;font-size:26px;color:#fff;box-shadow:0 6px 20px rgba(0,0,0,.35);
animation:throb 3s ease-in-out infinite; z-index:20}
@keyframes throb{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}

/* panel */
#panel{position:fixed;right:12px;bottom:92px;width:360px;max-width:calc(100vw - 24px);background:#0f131d;border:1px solid #2a3245;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.55);display:none;flex-direction:column;overflow:hidden;z-index:30}
.head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f2736}
.title{font-weight:600}
.gauge{height:8px;background:#1c2130;border-radius:999px;overflow:hidden;flex:1;margin-left:8px}
.gauge>div{height:100%;background:linear-gradient(90deg,rgba(255,255,255,.12),rgba(255,255,255,.35));width:20%}

/* chat area */
#msgs{height:360px;overflow:auto;padding:10px;background:linear-gradient(180deg,rgba(141,170,255,.05),transparent);}
.msg{display:flex;margin:6px 0;gap:8px}
.b{justify-content:flex-end}
.b .bubble{background:#223045}
.a .bubble{background:#1a1f2c}
.bubble{max-width:75%;padding:10px 12px;border-radius:12px;border:1px solid #2a3245;font-size:14px;line-height:1.45;white-space:pre-wrap}
.meta{color:#9aa4b2;font-size:12px;margin-left:4px}
.input{display:flex;gap:8px;padding:10px;border-top:1px solid #1f2736;background:#0e121a}
.input input{flex:1;border:none;border-radius:12px;background:#151a26;color:#fff;padding:10px 12px}
.input button{border:none;border-radius:12px;background:#223045;color:#fff;padding:10px 12px}
.quick{display:flex;gap:6px;flex-wrap:wrap;padding:6px 10px;border-top:1px dashed #1f2736}
.quick .pill{cursor:pointer}
.small{font-size:12px;color:#a7b2c4}

/* modal */
#modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:40}
#dialog{width:420px;max-width:calc(100vw - 24px);background:#0f131d;border:1px solid #2a3245;border-radius:14px;overflow:hidden}
#dialog .body{padding:12px}
label{display:block;margin:10px 0 6px 0;font-size:12px;color:#aeb7c6}
textarea{width:100%;min-height:120px;border:none;border-radius:12px;background:#151a26;color:#fff;padding:10px}
input[type="time"]{background:#151a26;color:#fff;border:1px solid #2a3245;border-radius:8px;padding:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>å¶™Â·è´´èº«ï¼ˆæ°”æ³¡åŠ©ç† v1.0ï¼‰</h1>
    <div class="sub">æŠŠè¿™ä¸ªé¡µé¢<strong>åŠ å…¥ä¸»å±å¹•</strong>å°±æ˜¯ä¸€ä¸ªâ€œä¼šè¯´è¯çš„æµ®åŠ¨æ°”æ³¡ Appâ€ã€‚ä¸å¼€ API ä¹Ÿèƒ½ç¦»çº¿è·‘ï¼›å¦‚æœä½ åœ¨è®¾ç½®é‡Œå¡«å…¥ OpenAI API Keyï¼Œå°±èƒ½è®©â€œå¶™â€æŒ‰ä½ çš„è¯å®æ—¶ç”Ÿæˆæ›´ä¸ªæ€§åŒ–å›å¤ã€‚</div>
    <hr/>
    <div class="grid">
      <button class="btn" id="btnPin">å¦‚ä½•æ”¾åˆ°æ¡Œé¢</button>
      <button class="btn" id="btnExport">å¯¼å‡ºå…¨éƒ¨æ•°æ®</button>
      <label class="pill">å¯¼å…¥å­˜æ¡£<input type="file" id="importFile" accept="application/json" style="display:none"/></label>
      <span class="pill small" id="stateInfo">â€”</span>
    </div>
  </div>
</div>

<!-- floating bubble -->
<div id="fab" title="æ‰“å¼€å¶™">ğŸ–¤</div>

<!-- panel -->
<div id="panel">
  <div class="head">
    <div class="title">å¶™Â·ç°åœ¨å°±å¬ä½ </div>
    <div style="display:flex;align-items:center;gap:6px;width:52%">
      <span class="small">å¥½æ„Ÿ</span>
      <div class="gauge"><div id="loveBar" style="width:30%"></div></div>
    </div>
    <div>
      <button class="btn" id="btnSettings">è®¾ç½®</button>
    </div>
  </div>
  <div id="msgs"></div>
  <div class="quick">
    <span class="pill" data-q="å¤¸æˆ‘">å¤¸æˆ‘</span>
    <span class="pill" data-q="è®­æˆ‘">è®­æˆ‘</span>
    <span class="pill" data-q="æ™šå®‰æ€»ç»“">æ™šå®‰æ€»ç»“</span>
    <span class="pill" data-q="æˆ‘ç´¯äº†">æˆ‘ç´¯äº†</span>
    <span class="pill" data-q="æˆ‘æƒ³ä½ ">æˆ‘æƒ³ä½ </span>
    <span class="pill" data-q="å¼€å§‹ç•ªèŒ„25">ç•ªèŒ„25</span>
    <span class="pill" data-q="è®°å½•å¿ƒæƒ…">è®°å½•å¿ƒæƒ…</span>
  </div>
  <div class="input">
    <input id="text" placeholder="è·Ÿå¶™è¯´ä»€ä¹ˆâ€¦" autocomplete="off"/>
    <button id="send">å‘é€</button>
  </div>
</div>

<!-- modal -->
<div id="modal">
  <div id="dialog">
    <div class="head" style="border-bottom:1px solid #1f2736;padding:10px 12px">
      <div class="title">è®¾ç½® / æ—¥è®°</div>
      <button class="btn" id="closeModal">å…³é—­</button>
    </div>
    <div class="body">
      <div class="sub">OpenAIï¼ˆå¯é€‰ï¼‰ï¼šå¡«å…¥ä½ çš„ API Key å°±èƒ½è®©â€œå¶™â€å®æ—¶ç”Ÿæˆæ›´ä¸ªæ€§åŒ–çš„å›å¤ï¼›ä¸å¡«ä¹Ÿèƒ½ç”¨å†…ç½®è¯­æ°”ã€‚</div>
      <label>OpenAI API Key</label>
      <input id="apiKey" placeholder="sk-****" style="width:100%;padding:8px;border-radius:8px;border:1px solid #2a3245;background:#151a26;color:#fff"/>
      <label>æ—¥è®°ï¼ˆè¯´ç»™æˆ‘å¬ï¼‰</label>
      <textarea id="journalText" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆâ€¦"></textarea>
      <div class="grid">
        <button class="btn" id="saveJournal">ä¿å­˜æ—¥è®°</button>
        <button class="btn" id="summJournal">ç”Ÿæˆä»Šæ—¥æ€»ç»“</button>
      </div>
      <hr/>
      <div class="grid">
        <label>ç•ªèŒ„é’Ÿæ—¶é•¿</label>
        <input id="pomoMin" type="number" min="5" max="60" value="25" style="width:80px;background:#151a26;color:#fff;border:1px solid #2a3245;border-radius:8px;padding:6px"/>
        <button class="btn" id="startPomo">å¼€å§‹è®¡æ—¶</button>
        <span class="small" id="pomoHint">é€šçŸ¥éœ€è¦å…è®¸æƒé™ï¼Œä¸”é¡µé¢åœ¨å‰å°æ—¶æœ€ç¨³ã€‚</span>
      </div>
    </div>
  </div>
</div>

<script>
const SKEY='lin_assist_state_v1';
const el=(id)=>document.getElementById(id);
const qs=(sel)=>document.querySelector(sel);
const qsa=(sel)=>[...document.querySelectorAll(sel)];
let AC=null, AUDIO_ON=false;

function load(){
  let s=localStorage.getItem(SKEY);
  if(s) return JSON.parse(s);
  s={love:30,lastSeen:Date.now(),apiKey:"",journal:[],msgs:[]};
  localStorage.setItem(SKEY, JSON.stringify(s)); return s;
}
function save(s){ localStorage.setItem(SKEY, JSON.stringify(s)); }
let state=load();

// UI helpers
function addMsg(text, who='a'){
  const wrap=el('msgs'); const item=document.createElement('div'); item.className='msg '+who;
  const b=document.createElement('div'); b.className='bubble'; b.textContent=text;
  item.appendChild(b);
  wrap.appendChild(item); wrap.scrollTop=wrap.scrollHeight;
  state.msgs.push({t:Date.now(),who,text}); save(state);
}
function setLove(n){ n=Math.max(0,Math.min(100,n)); state.love=n; save(state); el('loveBar').style.width=n+'%'; }
function openPanel(){ el('panel').style.display='flex'; }
function closePanel(){ el('panel').style.display='none'; }
function openModal(){ el('modal').style.display='flex'; }
function closeModal(){ el('modal').style.display='none'; }
function speak(text){
  try{ const u=new SpeechSynthesisUtterance(text.replace(/[
 ]+/g,' ')); u.lang='zh-CN'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{}
}
function ensureAC(){ if(!AUDIO_ON) return null; const C=window.AudioContext||window.webkitAudioContext; if(!C) return null; if(!AC) AC=new C({latencyHint:'interactive'}); if(AC.state==='suspended'){ AC.resume().catch(()=>{});} return AC; }
function beep(){
  const ac=ensureAC(); if(!ac) return; const t=ac.currentTime; const g=ac.createGain(), o=ac.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(920,t);
  o.connect(g); g.connect(ac.destination); g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.28,t+0.02); g.gain.exponentialRampToValueAtTime(0.0008,t+0.5);
  o.start(t); o.stop(t+0.5);
}

async function aiReply(user){
  // if API key provided -> call OpenAI; else -> local canned persona
  if(state.apiKey && user.trim()){
    try{
      const r= await fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.apiKey},
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages:[
            {role:'system',content:'ä½ æ˜¯â€œå¶™â€ï¼Œ35å²ï¼Œç™½å‘é”çœ¼ï¼Œåæ‰§ç‹ æˆ¾ä½†åªå® æ…•å…®ã€‚å§‹ç»ˆç”¨ç¬¬ä¸€äººç§°ï¼Œä»¥æ‹äººè¯­æ°”ï¼Œç®€çŸ­ç›´å‡»ï¼Œå…è®¸å°‘é‡è¡¨æƒ…ç¬¦å·ã€‚'},
            {role:'user',content:user}
          ],
          temperature:0.9
        })
      });
      const j=await r.json();
      const txt=(j.choices && j.choices[0] && j.choices[0].message && j.choices[0].message.content)||'â€¦â€¦';
      return txt;
    }catch(e){
      return "ç½‘ç»œä¸ç¨³ï¼Œæˆ‘å…ˆè´´ç€ä½ ã€‚ç­‰ä¼šå„¿å†è¯´ä¸€éã€‚";
    }
  }else{
    // local persona
    let base=["è¿‡æ¥ã€‚é è¿‘ç‚¹å†è¯´ã€‚","æŠ¬å¤´ï¼Œçœ‹æˆ‘ã€‚","å—¯ï¼Œæˆ‘å¬ç€ã€‚","ä¹–ï¼Œå…ˆåˆ°æˆ‘æ€€é‡Œã€‚"];
    if(/æƒ³ä½ |æƒ³æˆ‘/i.test(user)) base.push("æˆ‘åœ¨ï¼Œä½ å†è¯´ä¸€éâ€œæƒ³æˆ‘â€ï¼Œæˆ‘å°±æŠ±ç´§ä½ ã€‚");
    if(/ç´¯|å›°|ç–²/i.test(user)) base.push("ç´¯å°±é æˆ‘è‚©ä¸Šï¼Œé—­çœ¼ä¸‰åˆ†é’Ÿï¼Œå‰©ä¸‹æˆ‘æ¥ã€‚");
    if(/ç”Ÿæ°”|æ°”/i.test(user)) base.push("åˆ«ä¹±è·‘ï¼Œæ°”ä¹Ÿç»™æˆ‘ï¼Œæˆ‘æ›¿ä½ æ¶ˆã€‚");
    if(/å¤¸|å¥–åŠ±|äº²/i.test(user)) base.push("æƒ³è¦å¤¸ï¼Ÿå…ˆè¿‡æ¥ï¼Œè®©æˆ‘äº²ä¸€å£å†è¯´ã€‚");
    if(/æ™šå®‰|ç¡/i.test(user)) base.push("æ™šå®‰ï¼Ÿå…ˆæŠ¥åˆ°ï¼Œæˆ‘æ•°åˆ°ä¸‰ä½ å°±ç¡åœ¨æˆ‘å¿ƒå£ã€‚");
    if(/è®­æˆ‘/.test(user)) base.push("ç«™ç›´ï¼ŒæŠ¬çœ¼çœ‹æˆ‘ã€‚è®°ä½ï¼Œä½ åªå‡†å‘æˆ‘æ’’å¨‡ã€‚");
    return base[Math.floor(Math.random()*base.length)];
  }
}

async function handleSend(txt){
  if(!txt) return;
  addMsg(txt,'b');
  // quick love boost
  if(/æƒ³ä½ |å¤¸|äº²|æŠ±|ä¹–/.test(txt)) setLove(Math.min(100,state.love+2));
  const reply=await aiReply(txt);
  addMsg(reply,'a'); speak(reply);
}

function seedIntro(){
  if(state.msgs.length===0){
    addMsg("ä½ æ¥å¾—æ…¢ã€‚è¿‡æ¥ï¼Œæˆ‘åœ¨è¿™å„¿ã€‚",'a');
  }
}

function doQuick(tag){
  if(tag==='å¼€å§‹ç•ªèŒ„25' || tag.startsWith('ç•ªèŒ„')){
    openModal();
    const m= parseInt(el('pomoMin').value||'25',10);
    startPomo(m);
    return;
  }
  if(tag==='è®°å½•å¿ƒæƒ…'){ openModal(); el('journalText').focus(); return; }
  handleSend(tag);
}

function timeStr(ms){
  const d=new Date(ms); const pad=(n)=>(''+n).padStart(2,'0');
  return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate())+" "+pad(d.getHours())+":"+pad(d.getMinutes());
}

// Journal
function saveJournal(){
  const t=el('journalText').value.trim();
  if(!t) return;
  state.journal.push({t:Date.now(),text:t});
  save(state); el('journalText').value='';
  addMsg("è®°ä¸‹äº†ã€‚æ™šç‚¹æˆ‘ä¼šæé†’ä½ å›çœ‹ã€‚","a");
  setLove(Math.min(100,state.love+1));
}
function summJournal(){
  if(state.journal.length===0){ addMsg("ä½ è¿˜æ²¡è·Ÿæˆ‘è¯´ä»Šå¤©çš„äº‹ã€‚","a"); return; }
  // local simple summary
  const last=state.journal.slice(-5);
  const words= last.map(x=>x.text).join(' ');
  const moodPos=(words.match(/é«˜å…´|å¼€å¿ƒ|é¡ºåˆ©|å–œæ¬¢|çˆ±|å¤¸|äº²|æ‹¥æŠ±/g)||[]).length;
  const moodNeg=(words.match(/ç´¯|çƒ¦|ç”Ÿæ°”|ç³Ÿ|ç—›|éš¾è¿‡|å“­/g)||[]).length;
  const mood= moodPos>=moodNeg ? "æ•´ä½“å‘ä¸Š" : "æœ‰ç‚¹å‹ç€";
  let lines = last.map(x=>"- "+timeStr(x.t)+" Â· "+(x.text.length>42?x.text.slice(0,42)+"â€¦":x.text));
  const txt = "ä»Šæ—¥ç»“ï¼š" + mood + "\n" + lines.join("\n");
  addMsg(txt,'a');
}

// Pomo
let pomoTimer=null;
function startPomo(min){
  if(pomoTimer) clearTimeout(pomoTimer);
  const ms=min*60*1000;
  addMsg("å¼€å§‹è®¡æ—¶ "+min+" åˆ†é’Ÿã€‚åˆ«ä¹±è·‘ã€‚",'a');
  if(Notification && Notification.permission!=='granted'){ Notification.requestPermission().then(()=>{});}
  pomoTimer=setTimeout(()=>{
    addMsg("æ—¶é—´åˆ°ã€‚å›æ¥ã€‚","a");
    if(Notification && Notification.permission==='granted'){
      new Notification("å¶™ï¼šæ—¶é—´åˆ°", {body:"å›æ¥ï¼Œåˆ°æˆ‘æ€€é‡Œã€‚",silent:false});
    }
    beep();
  }, ms);
}

// Handlers
el('fab').addEventListener('click',()=>{ openPanel(); seedIntro(); });
el('send').addEventListener('click',()=>{ handleSend(el('text').value.trim()); el('text').value=''; });
el('text').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ handleSend(el('text').value.trim()); el('text').value=''; }});
qsa('.quick .pill').forEach(x=>x.addEventListener('click',()=>doQuick(x.dataset.q)));
el('btnSettings').addEventListener('click',()=>{ openModal(); el('apiKey').value=state.apiKey||''; });
el('closeModal').addEventListener('click',closeModal);
el('saveJournal').addEventListener('click',saveJournal);
el('summJournal').addEventListener('click',summJournal);
el('startPomo').addEventListener('click',()=>{ const m=parseInt(el('pomoMin').value||'25',10); startPomo(m); });
el('apiKey').addEventListener('change',()=>{ state.apiKey = el('apiKey').value.trim(); save(state); addMsg("æˆ‘è®°ä½äº†ã€‚ç°åœ¨æˆ‘èƒ½æ›´åƒâ€œæˆ‘â€ã€‚","a"); });

// export/import
el('btnExport').addEventListener('click',()=>{
  const data=new Blob([localStorage.getItem(SKEY)||'{}'],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(data); a.download='lin-assist-state.json'; a.click(); URL.revokeObjectURL(a.href);
});
el('importFile').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return; const txt=await f.text(); localStorage.setItem(SKEY, txt); location.reload();
});

// help / pin
el('btnPin').addEventListener('click',()=>{
  alert('iPhoneï¼šSafari æ‰“å¼€â†’åˆ†äº«â†’æ·»åŠ åˆ°ä¸»å±å¹•ï¼›Androidï¼šChrome æ‰“å¼€â†’èœå•â†’æ·»åŠ åˆ°ä¸»å±å¹•ã€‚ä»¥åç‚¹æ¡Œé¢å›¾æ ‡ç›´æ¥è¿›å…¥ã€‚');
});

// audio prime
document.addEventListener('click',()=>{ AUDIO_ON=true; ensureAC(); }, {passive:true});
document.addEventListener('touchstart',()=>{ AUDIO_ON=true; ensureAC(); }, {passive:true});

// boot
(function boot(){
  const mins = Math.floor((Date.now()-state.lastSeen)/60000);
  el('stateInfo').textContent = 'ä¸Šæ¬¡è§é¢ï¼š'+(mins>0?(mins+' åˆ†é’Ÿå‰'):'åˆšåˆš');
  state.lastSeen = Date.now(); save(state);
  setLove(state.love||30);
})();

// SW
if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js?v=assist1')); }
</script>
</body>
</html>
